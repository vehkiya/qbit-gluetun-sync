name: PR Validation

on:
    pull_request:
        branches: ["master", "main"]

jobs:
    validate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.23" # Matches Dockerfile

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v6
              with:
                  version: latest

            - name: Run Tests
              run: go test -v -race ./...

    security:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Build Docker Image
              run: docker build -t qbit-sync:pr-test .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: "qbit-sync:pr-test"
                  format: "table"
                  exit-code: "1"
                  ignore-unfixed: true
                  vuln-type: "os,library"
                  severity: "CRITICAL,HIGH"
